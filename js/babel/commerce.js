'use strict';

(function () {

  // format card form inputs
  $('.cc-num-input').payment('formatCardNumber');
  $('.cc-exp-input').payment('formatCardExpiry');
  $('.cc-cvc-input').payment('formatCardCVC');

  //
  // general helpers:
  //

  // add error css class
  function addErr(input) {
    $(input).removeClass('input-success');
    $(input).addClass('input-error');
  }

  // add success css class
  function addOk(input) {
    $(input).removeClass('input-error');
    $(input).addClass('input-success');
  }

  // show input error icon
  function showInputErrIcon(input, iconSuc, iconErr) {
    if ($(input).hasClass('input-error')) {
      $(iconSuc).addClass('hidden');
      $(iconErr).removeClass('hidden');
    }
  }

  // show input success icon
  function showInputOkIcon(input, iconSuc, iconErr) {
    if ($(input).hasClass('input-success')) {
      $(iconSuc).removeClass('hidden');
      $(iconErr).addClass('hidden');
    }
  }

  // reset input icons
  function resetInput(input, iconSuc, iconErr) {
    $(input).removeClass('input-error');
    $(iconSuc).addClass('hidden');
    $(iconErr).addClass('hidden');
    $(input).removeClass('input-success');
  }

  //
  // check stuff
  //

  // check CARD NUMBER
  (function () {

    // card number css classes setting
    var cardNum = {
      input: '.cc-num-input',
      type: '.cc-type',
      iconOk: '.cc-num-icon-success',
      iconErr: '.cc-num-icon-error'
    };

    // highlight selected card type (brand)
    function markCardType(name) {
      if ($(cardNum.input).hasClass(name)) {
        $(cardNum.type + '.' + name).addClass('blue');
      }
    }

    // reset card type highlight
    function resetCardType() {
      $(cardNum.type).removeClass('blue');
    }

    // validate card number input
    function validCardNum() {

      // get card number
      var cardValue = $(cardNum.input).val();

      // validate card number
      var cardValid = $.payment.validateCardNumber(cardValue);

      // add proper indicators to valid/invalid number
      if (cardValid === true) {
        addOk(cardNum.input);
        showInputOkIcon(cardNum.input, cardNum.iconOk, cardNum.iconErr);
      }
      if (cardValid === false) {
        addErr(cardNum.input);
        showInputErrIcon(cardNum.input, cardNum.iconOk, cardNum.iconErr);
      }
    }

    // listen to card number input
    $(cardNum.input).on('input', function () {

      // when input is long enough...
      if ($(this).val().length > 1) {

        // highlight proper card type name
        markCardType('visa');
        markCardType('mastercard');
        markCardType('amex');
        markCardType('discover');

        // validate number according to statements
        if ($(this).hasClass('amex') && $(this).val().length > 16) {

          validCardNum();
        }

        if ($(this).hasClass('identified') && $(this).val().length > 17) {

          validCardNum();
        }

        // reset input indicators according to statements
        if ($(this).hasClass('amex') && $(this).val().length < 17) {

          resetInput(this, cardNum.iconOk, cardNum.iconErr);
        }

        if ($(this).hasClass('amex') === false && $(this).val().length < 19) {

          resetInput(this, cardNum.iconOk, cardNum.iconErr);
        }

        // show error if unknown
        if ($(this).hasClass('unknown')) {
          addErr(this);
          showInputErrIcon(this, cardNum.iconOk, cardNum.iconErr);
        }
      } else {
        resetInput(this, cardNum.iconOk, cardNum.iconErr);
        resetCardType();
      }
    });
  })(); // END card number check

  // check EXPIRY DATE
  (function () {

    // card expiry number css classes setting
    var cardExp = {
      input: '.cc-exp-input',
      iconOk: '.cc-exp-icon-success',
      iconErr: '.cc-exp-icon-error'
    };

    // validate number
    function validExp() {

      var expDate = $(cardExp.input).payment('cardExpiryVal');
      var expValidation = $.payment.validateCardExpiry(expDate.month, expDate.year);

      // add proper indicators to valid/invalid number
      if (expValidation === true) {
        addOk(cardExp.input);
        showInputOkIcon(cardExp.input, cardExp.iconOk, cardExp.iconErr);
      }
      if (expValidation === false) {
        addErr(cardExp.input);
        showInputErrIcon(cardExp.input, cardExp.iconOk, cardExp.iconErr);
      }
    }

    // listen to input
    $(cardExp.input).on('input', function () {

      // validate number when it's long enough
      if ($(this).val().length > 6) {
        validExp();
      }

      // otherwise, reset indicators
      else {
          resetInput(this, cardExp.iconOk, cardExp.iconErr);
        }
    });
  })(); // END expiry date check

  // check CVC NUMBER
  (function () {

    // CVC number css classes setting
    var cardCVC = {
      input: '.cc-cvc-input',
      iconOk: '.cc-cvc-icon-success',
      iconErr: '.cc-cvc-icon-error'
    };

    // validate number
    function cvcCheck(input) {
      var cvcNum = $(cardCVC.input).val();
      var cvcValid = $.payment.validateCardCVC(cvcNum);

      // add proper indicators to valid/invalid number
      if (cvcValid === true) {
        addOk(cardCVC.input);
        showInputOkIcon(cardCVC.input, cardCVC.iconOk, cardCVC.iconErr);
      }
      if (cvcValid === false) {
        addErr(cardCVC.input);
        showInputErrIcon(cardCVC.input, cardCVC.iconOk, cardCVC.iconErr);
      }
    }

    // listen to input
    $(cardCVC.input).on('input', function () {

      // validate number when it's long enough
      if ($(this).val().length > 2) {
        cvcCheck(this);
      }

      // otherwise, reset indicators
      else {
          resetInput(this, cardCVC.iconOk, cardCVC.iconErr);
        }
    });
  })(); // END cvc num check
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbW1lcmNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsQUFBQyxDQUFBLFlBQVc7OztBQUdaLEdBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUMvQyxHQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDL0MsR0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUM7Ozs7Ozs7QUFBQyxBQU81QyxXQUFTLE1BQU0sQ0FBQyxLQUFLLEVBQUU7QUFDckIsS0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUN0QyxLQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0dBQ2xDOzs7QUFBQSxBQUdELFdBQVMsS0FBSyxDQUFDLEtBQUssRUFBRTtBQUNwQixLQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ3BDLEtBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLENBQUM7R0FDcEM7OztBQUFBLEFBR0QsV0FBUyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRTtBQUNqRCxRQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLEVBQUc7QUFDdEMsT0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM5QixPQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQ2xDO0dBQ0Y7OztBQUFBLEFBR0QsV0FBUyxlQUFlLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUU7QUFDaEQsUUFBSyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxFQUFHO0FBQ3hDLE9BQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDakMsT0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUMvQjtHQUNGOzs7QUFBQSxBQUdELFdBQVMsVUFBVSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFO0FBQzNDLEtBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDcEMsS0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM5QixLQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzlCLEtBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLENBQUM7R0FDdkM7Ozs7Ozs7QUFBQSxBQVFELEFBQUMsR0FBQSxZQUFXOzs7QUFHVixRQUFNLE9BQU8sR0FBRztBQUNkLFdBQUssRUFBRSxlQUFlO0FBQ3RCLFVBQUksRUFBRyxVQUFVO0FBQ2pCLFlBQU0sRUFBRSxzQkFBc0I7QUFDOUIsYUFBTyxFQUFFLG9CQUFvQjtLQUM5Qjs7O0FBQUMsQUFHRixhQUFTLFlBQVksQ0FBQyxJQUFJLEVBQUU7QUFDMUIsVUFBSyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRztBQUNyQyxTQUFDLENBQUMsT0FBTyxDQUFDLElBQUksR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO09BQy9DO0tBQ0Y7OztBQUFBLEFBR0QsYUFBUyxhQUFhLEdBQUc7QUFDdkIsT0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7S0FDckM7OztBQUFBLEFBR0QsYUFBUyxZQUFZLEdBQUc7OztBQUd0QixVQUFNLFNBQVMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRTs7O0FBQUMsQUFHekMsVUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUM7OztBQUFDLEFBRzFELFVBQUssU0FBUyxLQUFLLElBQUksRUFBRztBQUN4QixhQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3JCLHVCQUFlLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztPQUNqRTtBQUNELFVBQUssU0FBUyxLQUFLLEtBQUssRUFBRztBQUN6QixjQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3RCLHdCQUFnQixDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7T0FDbEU7S0FDRjs7O0FBQUEsQUFHRCxLQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsWUFBVzs7O0FBR3RDLFVBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUc7OztBQUc5QixvQkFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3JCLG9CQUFZLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDM0Isb0JBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNyQixvQkFBWSxDQUFDLFVBQVUsQ0FBQzs7O0FBQUMsQUFHekIsWUFBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUMzQixDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFBRzs7QUFFNUIsc0JBQVksRUFBRSxDQUFDO1NBQ2hCOztBQUVELFlBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFDakMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sR0FBRyxFQUFFLEVBQUc7O0FBRTVCLHNCQUFZLEVBQUUsQ0FBQztTQUNoQjs7O0FBQUEsQUFHRCxZQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQzNCLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxNQUFNLEdBQUcsRUFBRSxFQUFHOztBQUU1QixvQkFBVSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUNuRDs7QUFFRCxZQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssS0FBSyxJQUNuQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFBRzs7QUFFOUIsb0JBQVUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDbkQ7OztBQUFBLEFBR0QsWUFBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFHO0FBQ2pDLGdCQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDYiwwQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDekQ7T0FFRixNQUVJO0FBQ0wsa0JBQVUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDbEQscUJBQWEsRUFBRSxDQUFDO09BQ2Y7S0FFRixDQUFDLENBQUM7R0FFSixDQUFBLEVBQUU7OztBQUFFLEFBSUwsQUFBQyxHQUFBLFlBQVc7OztBQUdWLFFBQU0sT0FBTyxHQUFHO0FBQ2QsV0FBSyxFQUFFLGVBQWU7QUFDdEIsWUFBTSxFQUFFLHNCQUFzQjtBQUM5QixhQUFPLEVBQUUsb0JBQW9CO0tBQzlCOzs7QUFBQyxBQUdGLGFBQVMsUUFBUSxHQUFHOztBQUVsQixVQUFNLE9BQU8sR0FBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUN6RCxVQUFNLGFBQWEsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQzs7O0FBQUMsQUFHaEYsVUFBSSxhQUFhLEtBQUssSUFBSSxFQUFFO0FBQzFCLGFBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDckIsdUJBQWUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO09BQ2pFO0FBQ0QsVUFBSSxhQUFhLEtBQUssS0FBSyxFQUFFO0FBQzNCLGNBQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDdEIsd0JBQWdCLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztPQUNsRTtLQUNGOzs7QUFBQSxBQUdELEtBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxZQUFXOzs7QUFHdEMsVUFBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRztBQUM5QixnQkFBUSxFQUFFLENBQUM7Ozs7QUFDWixXQUdJO0FBQ0gsb0JBQVUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDbkQ7S0FDRixDQUFDLENBQUM7R0FFSixDQUFBLEVBQUU7OztBQUFFLEFBSUwsQUFBQyxHQUFBLFlBQVc7OztBQUdWLFFBQU0sT0FBTyxHQUFHO0FBQ2QsV0FBSyxFQUFFLGVBQWU7QUFDdEIsWUFBTSxFQUFFLHNCQUFzQjtBQUM5QixhQUFPLEVBQUUsb0JBQW9CO0tBQzlCOzs7QUFBQyxBQUdGLGFBQVMsUUFBUSxDQUFDLEtBQUssRUFBRTtBQUN2QixVQUFNLE1BQU0sR0FBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQ3JDLFVBQU0sUUFBUSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQzs7O0FBQUMsQUFHbkQsVUFBSSxRQUFRLEtBQUssSUFBSSxFQUFFO0FBQ3JCLGFBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDckIsdUJBQWUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO09BQ2pFO0FBQ0QsVUFBSSxRQUFRLEtBQUssS0FBSyxFQUFFO0FBQ3RCLGNBQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDdEIsd0JBQWdCLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztPQUNsRTtLQUNGOzs7QUFBQSxBQUdELEtBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxZQUFXOzs7QUFHdEMsVUFBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRztBQUM5QixnQkFBUSxDQUFDLElBQUksQ0FBQyxDQUFDOzs7O0FBQ2hCLFdBR0k7QUFDSCxvQkFBVSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUNuRDtLQUNGLENBQUMsQ0FBQztHQUVKLENBQUEsRUFBRTtDQUVGLENBQUEsRUFBRSxDQUFFO0FBRkEiLCJmaWxlIjoiY29tbWVyY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24oKSB7XG5cbi8vIGZvcm1hdCBjYXJkIGZvcm0gaW5wdXRzXG4kKCcuY2MtbnVtLWlucHV0JykucGF5bWVudCgnZm9ybWF0Q2FyZE51bWJlcicpO1xuJCgnLmNjLWV4cC1pbnB1dCcpLnBheW1lbnQoJ2Zvcm1hdENhcmRFeHBpcnknKTtcbiQoJy5jYy1jdmMtaW5wdXQnKS5wYXltZW50KCdmb3JtYXRDYXJkQ1ZDJyk7XG5cbi8vXG4vLyBnZW5lcmFsIGhlbHBlcnM6XG4vL1xuXG4vLyBhZGQgZXJyb3IgY3NzIGNsYXNzIFxuZnVuY3Rpb24gYWRkRXJyKGlucHV0KSB7XG4gICQoaW5wdXQpLnJlbW92ZUNsYXNzKCdpbnB1dC1zdWNjZXNzJyk7XG4gICQoaW5wdXQpLmFkZENsYXNzKCdpbnB1dC1lcnJvcicpO1xufVxuXG4vLyBhZGQgc3VjY2VzcyBjc3MgY2xhc3NcbmZ1bmN0aW9uIGFkZE9rKGlucHV0KSB7XG4gICQoaW5wdXQpLnJlbW92ZUNsYXNzKCdpbnB1dC1lcnJvcicpO1xuICAkKGlucHV0KS5hZGRDbGFzcygnaW5wdXQtc3VjY2VzcycpO1xufVxuXG4vLyBzaG93IGlucHV0IGVycm9yIGljb25cbmZ1bmN0aW9uIHNob3dJbnB1dEVyckljb24oaW5wdXQsIGljb25TdWMsIGljb25FcnIpIHtcbiAgaWYgKCAkKGlucHV0KS5oYXNDbGFzcygnaW5wdXQtZXJyb3InKSApIHtcbiAgICAkKGljb25TdWMpLmFkZENsYXNzKCdoaWRkZW4nKTtcbiAgICAkKGljb25FcnIpLnJlbW92ZUNsYXNzKCdoaWRkZW4nKTtcbiAgfVxufVxuXG4vLyBzaG93IGlucHV0IHN1Y2Nlc3MgaWNvblxuZnVuY3Rpb24gc2hvd0lucHV0T2tJY29uKGlucHV0LCBpY29uU3VjLCBpY29uRXJyKSB7XG4gIGlmICggJChpbnB1dCkuaGFzQ2xhc3MoJ2lucHV0LXN1Y2Nlc3MnKSApIHtcbiAgICAkKGljb25TdWMpLnJlbW92ZUNsYXNzKCdoaWRkZW4nKTtcbiAgICAkKGljb25FcnIpLmFkZENsYXNzKCdoaWRkZW4nKTtcbiAgfVxufVxuXG4vLyByZXNldCBpbnB1dCBpY29uc1xuZnVuY3Rpb24gcmVzZXRJbnB1dChpbnB1dCwgaWNvblN1YywgaWNvbkVycikge1xuICAkKGlucHV0KS5yZW1vdmVDbGFzcygnaW5wdXQtZXJyb3InKTtcbiAgJChpY29uU3VjKS5hZGRDbGFzcygnaGlkZGVuJyk7XG4gICQoaWNvbkVycikuYWRkQ2xhc3MoJ2hpZGRlbicpO1xuICAkKGlucHV0KS5yZW1vdmVDbGFzcygnaW5wdXQtc3VjY2VzcycpO1xufVxuXG5cbi8vXG4vLyBjaGVjayBzdHVmZlxuLy9cblxuLy8gY2hlY2sgQ0FSRCBOVU1CRVIgXG4oZnVuY3Rpb24oKSB7IFxuXG4gIC8vIGNhcmQgbnVtYmVyIGNzcyBjbGFzc2VzIHNldHRpbmdcbiAgY29uc3QgY2FyZE51bSA9IHtcbiAgICBpbnB1dDogJy5jYy1udW0taW5wdXQnLFxuICAgIHR5cGU6ICAnLmNjLXR5cGUnLFxuICAgIGljb25PazogJy5jYy1udW0taWNvbi1zdWNjZXNzJyxcbiAgICBpY29uRXJyOiAnLmNjLW51bS1pY29uLWVycm9yJ1xuICB9O1xuXG4gIC8vIGhpZ2hsaWdodCBzZWxlY3RlZCBjYXJkIHR5cGUgKGJyYW5kKVxuICBmdW5jdGlvbiBtYXJrQ2FyZFR5cGUobmFtZSkge1xuICAgIGlmICggJChjYXJkTnVtLmlucHV0KS5oYXNDbGFzcyhuYW1lKSApIHtcbiAgICAgICQoY2FyZE51bS50eXBlICsgJy4nICsgbmFtZSkuYWRkQ2xhc3MoJ2JsdWUnKTtcbiAgICB9XG4gIH1cblxuICAvLyByZXNldCBjYXJkIHR5cGUgaGlnaGxpZ2h0XG4gIGZ1bmN0aW9uIHJlc2V0Q2FyZFR5cGUoKSB7XG4gICAgJChjYXJkTnVtLnR5cGUpLnJlbW92ZUNsYXNzKCdibHVlJyk7XG4gIH1cblxuICAvLyB2YWxpZGF0ZSBjYXJkIG51bWJlciBpbnB1dFxuICBmdW5jdGlvbiB2YWxpZENhcmROdW0oKSB7XG4gICAgXG4gICAgLy8gZ2V0IGNhcmQgbnVtYmVyXG4gICAgY29uc3QgY2FyZFZhbHVlID0gJChjYXJkTnVtLmlucHV0KS52YWwoKTtcblxuICAgIC8vIHZhbGlkYXRlIGNhcmQgbnVtYmVyXG4gICAgY29uc3QgY2FyZFZhbGlkID0gJC5wYXltZW50LnZhbGlkYXRlQ2FyZE51bWJlcihjYXJkVmFsdWUpO1xuXG4gICAgLy8gYWRkIHByb3BlciBpbmRpY2F0b3JzIHRvIHZhbGlkL2ludmFsaWQgbnVtYmVyXG4gICAgaWYgKCBjYXJkVmFsaWQgPT09IHRydWUgKSB7XG4gICAgICBhZGRPayhjYXJkTnVtLmlucHV0KTsgXG4gICAgICBzaG93SW5wdXRPa0ljb24oY2FyZE51bS5pbnB1dCwgY2FyZE51bS5pY29uT2ssIGNhcmROdW0uaWNvbkVycik7XG4gICAgfVxuICAgIGlmICggY2FyZFZhbGlkID09PSBmYWxzZSApIHtcbiAgICAgIGFkZEVycihjYXJkTnVtLmlucHV0KTsgXG4gICAgICBzaG93SW5wdXRFcnJJY29uKGNhcmROdW0uaW5wdXQsIGNhcmROdW0uaWNvbk9rLCBjYXJkTnVtLmljb25FcnIpO1xuICAgIH1cbiAgfVxuXG4gIC8vIGxpc3RlbiB0byBjYXJkIG51bWJlciBpbnB1dFxuICAkKGNhcmROdW0uaW5wdXQpLm9uKCdpbnB1dCcsIGZ1bmN0aW9uKCkge1xuXG4gICAgLy8gd2hlbiBpbnB1dCBpcyBsb25nIGVub3VnaC4uLlxuICAgIGlmICggJCh0aGlzKS52YWwoKS5sZW5ndGggPiAxICkge1xuICAgICAgXG4gICAgICAvLyBoaWdobGlnaHQgcHJvcGVyIGNhcmQgdHlwZSBuYW1lXG4gICAgICBtYXJrQ2FyZFR5cGUoJ3Zpc2EnKTtcbiAgICAgIG1hcmtDYXJkVHlwZSgnbWFzdGVyY2FyZCcpO1xuICAgICAgbWFya0NhcmRUeXBlKCdhbWV4Jyk7XG4gICAgICBtYXJrQ2FyZFR5cGUoJ2Rpc2NvdmVyJyk7XG4gICAgICBcbiAgICAgIC8vIHZhbGlkYXRlIG51bWJlciBhY2NvcmRpbmcgdG8gc3RhdGVtZW50c1xuICAgICAgaWYgKCAkKHRoaXMpLmhhc0NsYXNzKCdhbWV4JykgICYmXG4gICAgICAgICQodGhpcykudmFsKCkubGVuZ3RoID4gMTYgKSB7XG4gICAgICAgIFxuICAgICAgICB2YWxpZENhcmROdW0oKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgaWYgKCAkKHRoaXMpLmhhc0NsYXNzKCdpZGVudGlmaWVkJykgJiZcbiAgICAgICAgJCh0aGlzKS52YWwoKS5sZW5ndGggPiAxNyApIHtcbiAgICAgICAgXG4gICAgICAgIHZhbGlkQ2FyZE51bSgpO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyByZXNldCBpbnB1dCBpbmRpY2F0b3JzIGFjY29yZGluZyB0byBzdGF0ZW1lbnRzXG4gICAgICBpZiAoICQodGhpcykuaGFzQ2xhc3MoJ2FtZXgnKSAmJlxuICAgICAgICAkKHRoaXMpLnZhbCgpLmxlbmd0aCA8IDE3ICkge1xuICAgICAgICBcbiAgICAgICAgcmVzZXRJbnB1dCh0aGlzLCBjYXJkTnVtLmljb25PaywgY2FyZE51bS5pY29uRXJyKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgaWYgKCAkKHRoaXMpLmhhc0NsYXNzKCdhbWV4JykgPT09IGZhbHNlICYmXG4gICAgICAgICAgJCh0aGlzKS52YWwoKS5sZW5ndGggPCAxOSApIHtcbiAgICAgICAgXG4gICAgICAgIHJlc2V0SW5wdXQodGhpcywgY2FyZE51bS5pY29uT2ssIGNhcmROdW0uaWNvbkVycik7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIHNob3cgZXJyb3IgaWYgdW5rbm93blxuICAgICAgaWYgKCAkKHRoaXMpLmhhc0NsYXNzKCd1bmtub3duJykgKSB7XG4gICAgICAgIGFkZEVycih0aGlzKTtcbiAgICAgICAgc2hvd0lucHV0RXJySWNvbih0aGlzLCBjYXJkTnVtLmljb25PaywgY2FyZE51bS5pY29uRXJyKTtcbiAgICAgIH1cblxuICAgIH1cbiAgICBcbiAgICBlbHNlIHtcbiAgICByZXNldElucHV0KHRoaXMsIGNhcmROdW0uaWNvbk9rLCBjYXJkTnVtLmljb25FcnIpO1xuICAgIHJlc2V0Q2FyZFR5cGUoKTsgXG4gICAgfVxuXG4gIH0pO1xuXG59KCkpOyAvLyBFTkQgY2FyZCBudW1iZXIgY2hlY2tcblxuXG4vLyBjaGVjayBFWFBJUlkgREFURSBcbihmdW5jdGlvbigpIHtcblxuICAvLyBjYXJkIGV4cGlyeSBudW1iZXIgY3NzIGNsYXNzZXMgc2V0dGluZ1xuICBjb25zdCBjYXJkRXhwID0ge1xuICAgIGlucHV0OiAnLmNjLWV4cC1pbnB1dCcsXG4gICAgaWNvbk9rOiAnLmNjLWV4cC1pY29uLXN1Y2Nlc3MnLFxuICAgIGljb25FcnI6ICcuY2MtZXhwLWljb24tZXJyb3InXG4gIH07XG5cbiAgLy8gdmFsaWRhdGUgbnVtYmVyXG4gIGZ1bmN0aW9uIHZhbGlkRXhwKCkge1xuICAgIFxuICAgIGNvbnN0IGV4cERhdGU9ICQoY2FyZEV4cC5pbnB1dCkucGF5bWVudCgnY2FyZEV4cGlyeVZhbCcpO1xuICAgIGNvbnN0IGV4cFZhbGlkYXRpb24gPSAkLnBheW1lbnQudmFsaWRhdGVDYXJkRXhwaXJ5KGV4cERhdGUubW9udGgsIGV4cERhdGUueWVhcik7XG4gICAgXG4gICAgLy8gYWRkIHByb3BlciBpbmRpY2F0b3JzIHRvIHZhbGlkL2ludmFsaWQgbnVtYmVyXG4gICAgaWYgKGV4cFZhbGlkYXRpb24gPT09IHRydWUpIHtcbiAgICAgIGFkZE9rKGNhcmRFeHAuaW5wdXQpOyBcbiAgICAgIHNob3dJbnB1dE9rSWNvbihjYXJkRXhwLmlucHV0LCBjYXJkRXhwLmljb25PaywgY2FyZEV4cC5pY29uRXJyKTtcbiAgICB9XG4gICAgaWYgKGV4cFZhbGlkYXRpb24gPT09IGZhbHNlKSB7XG4gICAgICBhZGRFcnIoY2FyZEV4cC5pbnB1dCk7IFxuICAgICAgc2hvd0lucHV0RXJySWNvbihjYXJkRXhwLmlucHV0LCBjYXJkRXhwLmljb25PaywgY2FyZEV4cC5pY29uRXJyKTtcbiAgICB9XG4gIH1cblxuICAvLyBsaXN0ZW4gdG8gaW5wdXRcbiAgJChjYXJkRXhwLmlucHV0KS5vbignaW5wdXQnLCBmdW5jdGlvbigpIHtcblxuICAgIC8vIHZhbGlkYXRlIG51bWJlciB3aGVuIGl0J3MgbG9uZyBlbm91Z2hcbiAgICBpZiAoICQodGhpcykudmFsKCkubGVuZ3RoID4gNiApIHtcbiAgICAgIHZhbGlkRXhwKCk7XG4gICAgfVxuICAgIFxuICAgIC8vIG90aGVyd2lzZSwgcmVzZXQgaW5kaWNhdG9yc1xuICAgIGVsc2Uge1xuICAgICAgcmVzZXRJbnB1dCh0aGlzLCBjYXJkRXhwLmljb25PaywgY2FyZEV4cC5pY29uRXJyKTtcbiAgICB9XG4gIH0pO1xuXG59KCkpOyAvLyBFTkQgZXhwaXJ5IGRhdGUgY2hlY2tcblxuXG4vLyBjaGVjayBDVkMgTlVNQkVSXG4oZnVuY3Rpb24oKSB7XG5cbiAgLy8gQ1ZDIG51bWJlciBjc3MgY2xhc3NlcyBzZXR0aW5nXG4gIGNvbnN0IGNhcmRDVkMgPSB7XG4gICAgaW5wdXQ6ICcuY2MtY3ZjLWlucHV0JyxcbiAgICBpY29uT2s6ICcuY2MtY3ZjLWljb24tc3VjY2VzcycsXG4gICAgaWNvbkVycjogJy5jYy1jdmMtaWNvbi1lcnJvcidcbiAgfTtcbiAgXG4gIC8vIHZhbGlkYXRlIG51bWJlclxuICBmdW5jdGlvbiBjdmNDaGVjayhpbnB1dCkge1xuICAgIGNvbnN0IGN2Y051bT0gJChjYXJkQ1ZDLmlucHV0KS52YWwoKTtcbiAgICBjb25zdCBjdmNWYWxpZCA9ICQucGF5bWVudC52YWxpZGF0ZUNhcmRDVkMoY3ZjTnVtKTtcbiAgICBcbiAgICAvLyBhZGQgcHJvcGVyIGluZGljYXRvcnMgdG8gdmFsaWQvaW52YWxpZCBudW1iZXJcbiAgICBpZiAoY3ZjVmFsaWQgPT09IHRydWUpIHtcbiAgICAgIGFkZE9rKGNhcmRDVkMuaW5wdXQpOyBcbiAgICAgIHNob3dJbnB1dE9rSWNvbihjYXJkQ1ZDLmlucHV0LCBjYXJkQ1ZDLmljb25PaywgY2FyZENWQy5pY29uRXJyKTtcbiAgICB9XG4gICAgaWYgKGN2Y1ZhbGlkID09PSBmYWxzZSkge1xuICAgICAgYWRkRXJyKGNhcmRDVkMuaW5wdXQpOyBcbiAgICAgIHNob3dJbnB1dEVyckljb24oY2FyZENWQy5pbnB1dCwgY2FyZENWQy5pY29uT2ssIGNhcmRDVkMuaWNvbkVycik7XG4gICAgfVxuICB9XG5cbiAgLy8gbGlzdGVuIHRvIGlucHV0XG4gICQoY2FyZENWQy5pbnB1dCkub24oJ2lucHV0JywgZnVuY3Rpb24oKSB7XG4gICAgXG4gICAgLy8gdmFsaWRhdGUgbnVtYmVyIHdoZW4gaXQncyBsb25nIGVub3VnaFxuICAgIGlmICggJCh0aGlzKS52YWwoKS5sZW5ndGggPiAyICkge1xuICAgICAgY3ZjQ2hlY2sodGhpcyk7XG4gICAgfVxuICAgIFxuICAgIC8vIG90aGVyd2lzZSwgcmVzZXQgaW5kaWNhdG9yc1xuICAgIGVsc2Uge1xuICAgICAgcmVzZXRJbnB1dCh0aGlzLCBjYXJkQ1ZDLmljb25PaywgY2FyZENWQy5pY29uRXJyKTtcbiAgICB9XG4gIH0pO1xuXG59KCkpOyAvLyBFTkQgY3ZjIG51bSBjaGVja1xuXG59KCkpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
